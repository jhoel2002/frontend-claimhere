<div *ngIf="isOpen()" class="fixed inset-0 z-50 flex items-start justify-center overflow-y-auto">

  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" (click)="close()"></div>
  
  <!-- Modal -->
  <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 animate-modal-up p-8 space-y-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-t-lg flex justify-between items-center">
      <h2 class="text-xl font-semibold text-white">{{request?.title}}</h2>
      <button class="text-white hover:text-gray-200 transition-colors" (click)="close()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

  <div *ngIf="['RECEIVED', 'VALIDATED', 'ASSIGNED', 'QUOTED', 'QUOTED_APPROVED'].includes(request?.status_request!)" class="overflow-x-auto pb-2">
    <ol class="flex items-center max-w-4xl mx-auto">

      <!-- Paso 0: Solicitud recibida -->
      <li class="flex w-full items-center"
          [ngClass]="{ 'text-blue-500 after:border-blue-800': isStep0Active(), 'text-gray-400 after:border-gray-400': !isStep0Active() }">
        <div class="flex items-center w-full after:content-[''] after:w-full after:h-1 after:border-b after:border-4 after:inline-block"
            [ngClass]="{ 'after:border-blue-800': isStep1Active(), 'after:border-gray-700': !isStep1Active() }">
          <span class="flex items-center justify-center w-10 h-10 rounded-full lg:h-12 lg:w-12 shrink-0"
                [ngClass]="{ 'bg-blue-800': isStep0Active(), 'bg-gray-700': !isStep0Active() }">
            <!-- Icono de sobre recibido -->
            <svg class="w-8 h-8"
                [ngClass]="{ 'text-blue-300': isStep0Active(), 'text-gray-300': !isStep0Active() }"
                xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 0 0 2.22 0L21 8m-18 8h18a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2z"/>
            </svg>
          </span>
        </div>
      </li>

      <!-- Paso 1: Validación del caso -->
      <li class="flex w-full items-center"
          [ngClass]="{ 'text-blue-500 after:border-blue-800': isStep1Active(), 'text-gray-400 after:border-gray-400': !isStep1Active() }">
        <div class="flex items-center w-full after:content-[''] after:w-full after:h-1 after:border-b after:border-4 after:inline-block"
            [ngClass]="{ 'after:border-blue-800': isStep2Active(), 'after:border-gray-700': !isStep2Active() }">
          <span class="flex items-center justify-center w-10 h-10 rounded-full lg:h-12 lg:w-12 shrink-0"
                [ngClass]="{ 'bg-blue-800': isStep1Active(), 'bg-gray-700': !isStep1Active() }">
            <!-- Icono de validación -->
            <svg class="w-8 h-8"
                [ngClass]="{ 'text-blue-300': isStep1Active(), 'text-gray-300': !isStep1Active() }"
                xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2l4-4m1-6H6a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V7l-5-5z"/>
            </svg>
          </span>
        </div>
      </li>

      <!-- Paso 2: Asignación de abogado -->
      <li class="flex w-full items-center"
          [ngClass]="{ 'text-blue-500 after:border-blue-800': isStep2Active(), 'text-gray-400 after:border-gray-400': !isStep2Active() }">
        <div class="flex items-center w-full after:content-[''] after:w-full after:h-1 after:border-b after:border-4 after:inline-block"
            [ngClass]="{ 'after:border-blue-800': isStep3Active(), 'after:border-gray-700': !isStep3Active() }">
          <span class="flex items-center justify-center w-10 h-10 rounded-full lg:h-12 lg:w-12 shrink-0"
                [ngClass]="{ 'bg-blue-800': isStep2Active(), 'bg-gray-700': !isStep2Active() }">
            <!-- Icono de asignación -->
            <svg class="w-8 h-8"
                [ngClass]="{ 'text-blue-300': isStep2Active(), 'text-gray-300': !isStep2Active() }"
                xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z"/>
            </svg>
          </span>
        </div>
      </li>

      <!-- Paso 3: Cotización -->
      <li class="flex w-full items-center"
          [ngClass]="{ 'text-blue-500 after:border-blue-800': isStep3Active(), 'text-gray-400 after:border-gray-400': !isStep3Active() }">
        <div class="flex items-center w-full after:content-[''] after:w-full after:h-1 after:border-b after:border-4 after:inline-block"
            [ngClass]="{ 'after:border-blue-800': isStep4Active(), 'after:border-gray-700': !isStep4Active() }">
          <span class="flex items-center justify-center w-10 h-10 rounded-full lg:h-12 lg:w-12 shrink-0"
                [ngClass]="{ 'bg-blue-800': isStep3Active(), 'bg-gray-700': !isStep3Active() }">
            <!-- Icono de cotización -->
            <svg class="w-8 h-8"
                [ngClass]="{ 'text-blue-300': isStep3Active(), 'text-gray-300': !isStep3Active() }"
                xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
            </svg>
          </span>
        </div>
      </li>

      <!-- Paso 4: Aceptación -->
      <li class="flex w-full items-center">
        <span class="flex items-center justify-center w-10 h-10 rounded-full lg:h-12 lg:w-12 shrink-0"
              [ngClass]="{ 'bg-blue-800': isStep4Active(), 'bg-gray-700': !isStep4Active() }">
          <!-- Icono de aceptación -->
          <svg class="w-8 h-8"
              [ngClass]="{ 'text-blue-300': isStep4Active(), 'text-gray-300': !isStep4Active() }"
              xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5 13l4 4L19 7" />
          </svg>
        </span>
      </li>
    </ol>
  </div>

    <!-- Content -->
    <div class="px-6">
      <!-- Case Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
        <div class="space-y-2">
          <p class="text-gray-600">Codigo del caso: <span class="font-medium text-gray-900">{{request?.code}}</span></p>
          <p class="text-gray-600">Tipo de caso: <span class="font-medium text-gray-900">{{request?.type_case}}</span></p>
          <p class="text-gray-600">Estado de la solicitud: 
            <span [ngClass]="getStatusClass()">{{request?.status_request}}</span>
          </p>
        </div>
        <div class="space-y-2">
          <p class="text-gray-600">Fecha de creacion: <span class="font-medium text-gray-900">{{request?.creation}}</span></p>
          <ng-container *ngIf="['ASSIGNED', 'QUOTED', 'QUOTED_APPROVED'].includes(request?.status_request!)">
            <p class="text-gray-600">Abogado: <span class="font-medium text-gray-900">{{request?.lawyerName}}</span></p>
          </ng-container>
        </div>
      </div>

      <div class="mb-4 space-y-2">
        <p class="text-gray-600">Descripción:</p>
        <div class="bg-gray-100 p-3 rounded-lg text-gray-900 whitespace-pre-wrap min-h-[80px] max-h-[400px] overflow-y-auto">
          {{request?.description}}
        </div>
      </div>

      <!-- Customer Details -->
      <div class="bg-gray-100 p-4 rounded-lg mb-4">
        <h3 class="text-lg font-medium text-gray-900 mb-2">Detalles del Cliente</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <p class="text-gray-600">Nombre: <span class="font-medium text-gray-900">{{request?.customerName}}</span></p>
            <p class="text-gray-600">Correo: <span class="font-medium text-gray-900">{{request?.customerEmail}}</span></p>
          </div>
          <div class="space-y-2">
            <p class="text-gray-600">Tipo de documento: <span class="font-medium text-gray-900">{{request?.customerDocumentType}}</span></p>
            <p class="text-gray-600">Numero de documento: <span class="font-medium text-gray-900">{{request?.customerDocumentNumber}}</span></p>
          </div>
        </div>
      </div>

      <!-- Cotización -->
      <div *ngIf="request?.status_request === 'ASSIGNED'" class="form-group">
        <label class="text-lg font-semibold text-gray-800">Cotización:</label>
        <input type="file" (change)="onFileSelected($event)" class="mt-1 block w-full p-2 text-sm text-gray-600">
        <div *ngIf="uploadError" class="text-red-600 text-xs">{{ uploadError }}</div>
      </div>

      <!-- Asignación de abogado -->
      <div *ngIf="request?.status_request === 'VALIDATED'" class="mb-4">
        <label class="text-lg font-semibold text-gray-800">
          Seleccionar Abogado:
        </label>
        <app-dropdown-customer
              [control]="lawyer"
              [label]="'Abogado'"
              [valueService]="lawyerService"
              [searchMethod]="'searchLawyers'"
              [typeCase]="request!.type_case!"
              [errorMsg]="lawyer.invalid && lawyer.touched ? (lawyer.errors?.['required'] ? 'El abogado es requerido.' : null) : null"
              >
        </app-dropdown-customer>
      </div>

      <div class="px-6">
        <h3 class="text-lg font-semibold text-gray-800 text-center mb-4">
          Descargar Documentos
        </h3>
        <div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
          <div *ngFor="let evidence of request?.evidences">
            <app-file-card [showIcon]="request!.evidences!.length <= 4" [document]="evidence"></app-file-card>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div *ngIf="entity === 'request-pending' || entity === 'request-approved'" class="flex items-center justify-end gap-2">
      <!-- Mostrar botones solo si el estado permite una acción -->
      <ng-container [ngSwitch]="request?.status_request?.toUpperCase()">

        <ng-container *ngSwitchCase="'RECEIVED'">
          <button type="button" (click)="udpateStatus('Rechazar')"
            class="px-5 py-2 text-sm text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 focus:outline-none font-medium rounded-md">
            Rechazar Caso
          </button>
          <button type="button" (click)="udpateStatus('Validar')"
            class="px-4 py-2 text-sm text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 focus:outline-none rounded-md font-medium">
            Validar Caso
          </button>
        </ng-container>

        <ng-container *ngSwitchCase="'VALIDATED'">
          <!-- <button type="button" (click)="downloadFileByCode(request?.cotization)"
            class="px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 focus:outline-none rounded-md font-medium">
            Descargar Cotizacion
          </button> -->
          <button type="button" (click)="udpateStatus('Asignar')"
            class="px-4 py-2 text-sm text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 focus:outline-none rounded-md font-medium">
            Asignar Abogado
          </button>
        </ng-container>

        <ng-container *ngSwitchCase="'ASSIGNED'">
          <button type="button" (click)="udpateStatus('Cotizar')"
            class="px-4 py-2 text-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:ring-4 focus:ring-yellow-300 focus:outline-none rounded-md font-medium">
            Cotizar Caso
          </button>
        </ng-container>

        <ng-container *ngSwitchCase="'QUOTED'">
          <button type="button" (click)="downloadFileByCode(request?.cotization)"
            class="px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 focus:outline-none rounded-md font-medium">
            Descargar Cotizacion
          </button>
        </ng-container>

        <ng-container *ngSwitchCase="'QUOTED_APPROVED'">
          <button type="button" (click)="downloadFileByCode(request?.cotization)"
            class="px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 focus:outline-none rounded-md font-medium">
            Descargar Cotizacion
          </button>
          <button type="button" (click)="udpateStatus('Aprobar')"
            class="px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 focus:outline-none rounded-md font-medium">
            Aprobar Caso
          </button>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>